---
title: "TSA Final Project"
author: "Shubhangi Gupta, Aditi Jackson, David Robinson"
date: "2024-03-29"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

## Setup

```{r packages}

# loading packages
library(tidyverse)
library(dplyr)
library(lubridate)
library(readxl)
library(ggplot2)
library(forecast)
library(Kendall)
library(tseries)
library(outliers)
library(smooth)
library(readr)
library(zoo)
library(cowplot)

```

# Data Wrangling

```{r wrangle}

#Importing data
transmission_RAW <- read_excel("Data/Raw/Transmission_Lines_1711480217358.xlsx",
                               col_names=TRUE)

#Renaming columns, subsetting date and line length columns and dropping NAs
transmission_CLEAN <- transmission_RAW %>%
  select("Line Length (cKM)",
         "Month Of Completion",
         "Year Of Completion (FY)") %>%
  rename("LineLength"= "Line Length (cKM)",
         "Month"="Month Of Completion",
         "Year"="Year Of Completion (FY)")

#Checking for N/As
any(is.na(transmission_CLEAN)) #this reveals that there are no NAs

#Splitting into month and 2-digit year
transmission_CLEAN <- transmission_CLEAN %>%
  separate(col = Month, into = c("Month", "YearSep"), sep = "-")

#Transforming to 4-digit year
transmission_CLEAN$four_digit_year <-
  as.numeric(paste0("20", transmission_CLEAN$YearSep))

#Concatenating into month and 4-digit year
transmission_CLEAN <- transmission_CLEAN %>%
  mutate(Date = paste0(Month, sep = "-", four_digit_year))

#Converting date column into a date object
transmission_CLEAN$Date <- my(transmission_CLEAN$Date)

#Grouping by date and summing up line length
transmission_CLEAN <- transmission_CLEAN %>%
  group_by(Date)%>%
  summarise(TotalLineLength = sum(LineLength)) %>%
  select("TotalLineLength","Date")

colnames(transmission_CLEAN)[names(transmission_CLEAN)=="TotalLineLength"] <-
  "AnnualAdditions"

#Cumulative annual additions to get total line length in each month
transmission_CLEAN <- transmission_CLEAN %>%
  mutate(cumsum(AnnualAdditions))%>%
  rename("TotalLineLength" = "cumsum(AnnualAdditions)")

#Reordering columns
transmission_CLEAN <- select(transmission_CLEAN, Date, TotalLineLength,
                             AnnualAdditions)

#Initial plot
ggplot(transmission_CLEAN,aes(x=Date,y=TotalLineLength))+
 geom_line() +
  geom_smooth(method = lm)

```

# TIME SERIES ANALYSIS

```{r time series}

#Creating time series object
transmission_ts <- ts(transmission_CLEAN[,2],start=c(2015,4),end = c(2024,1),
                      frequency = 12)

#Plotting the time series, ACF and PACF
ts_plot <- autoplot(transmission_ts)+
  ylab("Total Line Length (ckm)")+
  ggtitle("Original TS")
ACF <- acf(transmission_ts, lag.max = 40, plot=FALSE)
PACF <- Pacf(transmission_ts, lag.max = 40, plot=FALSE)

plot_grid(ts_plot, autoplot(ACF), autoplot(PACF), nrow = 1)

#Observations: trend is declining, ACF - significant ->
#MA required - no because it's just a few significant ones in the first 12 lags

```

## DECOMPOSITION AND STATISTICAL TESTING

```{r decompose}

#Decompose
transmission_ts_decomp <- decompose(transmission_ts, "additive")
print(plot(transmission_ts_decomp))

#We did not use the decomposed data in our analysis -- removing the seasonality
#was making things worse.

#Mann-Kendall and ADF to determine d term of ARIMA
SMKtest <- SeasonalMannKendall(transmission_ts)
print(summary(SMKtest))

ADFTest <- adf.test(transmission_ts, alternative = "stationary")
print(ADFTest)

#Observations:
#Only SMK is rejected. SMK rejection -> deterministic
#ADF not rejected -> not stationary
#Therefore, the data does not require de-seasoning.

```

```{r test and train}

#Defining the training and testing data sets
transmission_training <-
  transmission_CLEAN[1:96,] #April of 2015 through March of 2023
transmission_testing <-
  transmission_CLEAN[97:106,] #April of 2023 through January of 2024

#Creating time series of training and testing data sets
transmission_ts_training <- ts(transmission_training[,2], 
                               start=c(2015,4),end = c(2023,3),frequency=12)
transmission_ts_testing <- ts(transmission_testing[,2],
                              start=c(2023, 4),end = c(2024,1),frequency = 12)

```

## FITTING AND FORECASTING

```{r SARIMA model and forecast}

#Fitting auto ARIMA model on training data
print(auto.arima(transmission_ts_training))
transmission_training_ARIMA021101 <- Arima(transmission_ts_training, 
                                           order=c(0,2,1), seasonal=c(1,0,1), 
                                           include.constant = TRUE)
summary(transmission_training_ARIMA021101)
checkresiduals(transmission_training_ARIMA021101)

#Forecasting using training data
sarima_forecast <- forecast(transmission_training_ARIMA021101, h=60)

#Plotting forecast and comparing to testing data
autoplot(transmission_ts, series = "original")+
  autolayer(transmission_training_ARIMA021101$fitted, series = "SARIMA")+
  autolayer(sarima_forecast$mean, series = "SARIMA_forecast")+
  ggtitle("SARIMA FORECAST")+
  ylab("Total Line Length (ckm)")

#Checking accuracy of forecast
accuracy(sarima_forecast)

```

```{r TBATS}

#Fit the TBATS model
tbats_model <- tbats(transmission_ts_training)

#Forecast using the fitted model
tbats_forecast <- forecast(tbats_model, h = 60)

#Plotting model
autoplot(transmission_ts, series = "original")+
  autolayer(tbats_model$fitted.values, series = "TBATS")+
  autolayer(tbats_forecast$mean, series = "TBATS_Forecast")+
  ggtitle("TBATS FORECAST")+
  ylab("Total Line Length (km)")

#Checking accuracy of forecast
accuracy(tbats_forecast)

```

```{r}

#Fitting neural network model using training data
NN_model <- nnetar(transmission_ts_training, p=0, P=1)

#Forecasting using NN model
NN_forecast <- forecast(NN_model, h=60)

#Plotting model
autoplot(transmission_ts, series = "original")+
  autolayer(NN_model$fitted, series = "Neural_Network")+
  autolayer(NN_forecast$mean, series = "Neural_Network_Model")+
  ggtitle("NEURAL NETWORK FORECAST")+
  ylab("Total Line Length (km)")

#Checking accuracy of forecast
accuracy(NN_forecast)

```

